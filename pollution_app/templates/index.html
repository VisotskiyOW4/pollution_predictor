<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Моніторинг якості води</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
    <h1 class="text-center mb-4">Моніторинг якості води в річках</h1>
    <div id="map" style="height: 500px;" class="mb-4"></div>

    <div id="graphs" class="card p-4 d-none">
        <h4 id="riverName">Річка</h4>
        <canvas id="lineChart" height="100"></canvas>
        <canvas id="barChart" height="100" class="mt-4"></canvas>

        <h5 class="mt-4">Введіть нові дані для прогнозу</h5>
        <form id="predictionForm">
            <input type="hidden" id="formRiverId">
            <div class="row mb-2">
                <div class="col">
                    <input type="number" step="0.1" class="form-control" id="temp" placeholder="Температура (°C)" required>
                </div>
                <div class="col">
                    <input type="number" step="0.1" class="form-control" id="ph" placeholder="pH" required>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col">
                    <input type="number" step="0.1" class="form-control" id="nitrogen" placeholder="Нітроген (mg/L)" required>
                </div>
                <div class="col">
                    <input type="number" step="0.1" class="form-control" id="flow" placeholder="Швидкість течії (m/s)" required>
                </div>
            </div>
            <button type="submit" class="btn btn-success">Прогнозувати</button>
        </form>
    </div>
</div>

<script>
const map = L.map('map').setView([48.4, 31.2], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

let lineChart = null;
let barChart = null;

fetch("/api/rivers/")
  .then(response => response.json())
  .then(rivers => {
    rivers.forEach(river => {
      const marker = L.marker([river.lat, river.lon]).addTo(map);
      marker.bindPopup(
        `<b>${river.name}</b><br>${river.description}<br><button class='btn btn-sm btn-primary mt-2' onclick='loadGraphs(${river.id}, "${river.name}")'>Показати графіки</button>`
      );
    });
  });

function drawCharts(data, riverName) {
  const labels = data.forecast.map((_, i) => `${i + 1}-й місяць`);

  // Очистка старих графіків
  if (lineChart) lineChart.destroy();
  if (barChart) barChart.destroy();

  const lineCtx = document.getElementById('lineChart').getContext('2d');
  const barCtx = document.getElementById('barChart').getContext('2d');

  lineChart = new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: `Рівень забруднення (лінійний графік)`,
        data: data.forecast,
        borderColor: 'rgba(75, 192, 192, 1)',
        tension: 0.3,
        fill: false
      }]
    }
  });

  barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: `Рівень забруднення (стовпчики)`,
        data: data.forecast,
        backgroundColor: 'rgba(54, 162, 235, 0.5)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, max: 1 }
      }
    }
  });
}

function loadGraphs(riverId, riverName) {
  document.getElementById('formRiverId').value = riverId;
  fetch(`/api/predictions/?river_id=${riverId}`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('graphs').classList.remove('d-none');
      document.getElementById('riverName').innerText = riverName;
      drawCharts(data, riverName);
    });
}

const form = document.getElementById('predictionForm');
form.addEventListener('submit', function(e) {
  e.preventDefault();
  const riverId = document.getElementById('formRiverId').value;
  const payload = {
    river_id: riverId,
    temperature: parseFloat(document.getElementById('temp').value),
    ph: parseFloat(document.getElementById('ph').value),
    nitrogen: parseFloat(document.getElementById('nitrogen').value),
    flow_speed: parseFloat(document.getElementById('flow').value)
  };

  fetch('/api/predict/', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('riverName').innerText = data.river;
    drawCharts(data, data.river); // ⚠ використовуємо результат прогнозу
  });
});
</script>


</body>
</html>
